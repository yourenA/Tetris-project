"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),Block=function(){function t(e){_classCallCheck(this,t),this.siteSize=e.siteSize,this.arr=e.arr,this.BLOCK_SIZE=e.BLOCK_SIZE,this.curLeft=e.curLeft,this.curTop=e.curTop}return _createClass(t,[{key:"clockwise",value:function(t){for(var e=[],r=0;r<=t.length-1;r++){for(var i=[],o=t.length-1;o>=0;o--)i.push(t[o][r]);e.push(i)}var n=[],a=[];return this.checkArrWith1(e,function(t,e){n.push(e*this.BLOCK_SIZE),a.push(t*this.BLOCK_SIZE)}),{newArr:e,lefts:n,tops:a}}},{key:"checkArrWith1",value:function(t,e){for(var r=0;r<=t.length-1;r++)for(var i=0;i<=t.length-1;i++)1==t[r][i]&&e.call(this,r+this.curTop,i+this.curLeft)}},{key:"draw",value:function(t,e){var r=document.createElement("div");r.className="activityModel",r.style.top=t*this.BLOCK_SIZE+"px",r.style.left=e*this.BLOCK_SIZE+"px",document.body.appendChild(r)}},{key:"getInterval",value:function(t,e){var r=document.querySelectorAll(".inactiveModel"),i=null,o=null,n=null;if(0===r.length)i=this.siteSize.top+this.siteSize.height,o=this.siteSize.left-this.BLOCK_SIZE,n=this.siteSize.left+this.siteSize.width;else{var a=[],l=[],s=[],c=!0,h=!1,u=void 0;try{for(var v,f=r[Symbol.iterator]();!(c=(v=f.next()).done);c=!0){var y=v.value,p=parseInt(y.style.left),d=parseInt(y.style.top);p===t&&a.push(d),d===e&&(p<t?l.push(p):p>t&&s.push(p))}}catch(t){h=!0,u=t}finally{try{!c&&f.return&&f.return()}finally{if(h)throw u}}i=0===a.length?this.siteSize.top+this.siteSize.height:Math.min.apply(Math,a),o=0===l.length?this.siteSize.left-this.BLOCK_SIZE:Math.max.apply(Math,l),n=0===s.length?this.siteSize.left+this.siteSize.width:Math.min.apply(Math,s)}return{highest:i,leftmost:o,rightmost:n}}},{key:"eliminate",value:function(){var t=[],e=[].concat(_toConsumableArray(document.querySelectorAll(".inactiveModel")));e.sort(function(t,e){return parseInt(t.style.top)-parseInt(e.style.top)});for(var r=0;r<e.length;){for(var i=0,o=[],n=0;n<e.length;n++)e[r].style.top===e[n].style.top&&(i++,o.push(e[n]));t.push({models:o,count:i,top:parseInt(e[r].style.top)}),r+=i}return t}},{key:"gameOver",value:function(){var t=document.querySelectorAll(".inactiveModel"),e=[],r=!0,i=!1,o=void 0;try{for(var n,a=t[Symbol.iterator]();!(r=(n=a.next()).done);r=!0){var l=n.value;e.push(parseInt(l.style.top))}}catch(t){i=!0,o=t}finally{try{!r&&a.return&&a.return()}finally{if(i)throw o}}return Math.min.apply(Math,e)<=this.siteSize.top}},{key:"canMove",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{canMoveRight:!0,canMoveDown:!0,canMoveLeft:!0};return this.checkArrWith1(t,function(t,o){var n=this.getInterval(o*this.BLOCK_SIZE,t*this.BLOCK_SIZE),a=n.highest,l=n.leftmost,s=n.rightmost;e?(this.BLOCK_SIZE*(o+1)>s&&(i.canMoveRight=!1),this.BLOCK_SIZE*(t+r)>a&&(i.canMoveDown=!1),this.BLOCK_SIZE*(o-1)<l&&(i.canMoveLeft=!1)):(this.BLOCK_SIZE*(o+1)>=s&&(i.canMoveRight=!1),this.BLOCK_SIZE*(t+r)>=a&&(i.canMoveDown=!1),this.BLOCK_SIZE*(o-1)<=l&&(i.canMoveLeft=!1))}),i}},{key:"move",value:function(){var t=this;document.onkeydown=function(e){var r=document.querySelectorAll(".activityModel"),i=void 0,o=void 0,n=void 0,a=void 0,l=e.keyCode;if(r.length)switch(l){case 37:if(n=t.canMove(t.arr).canMoveLeft){var s=!0,c=!1,h=void 0;try{for(var u,v=r[Symbol.iterator]();!(s=(u=v.next()).done);s=!0){var f=u.value;f.style.left=parseInt(f.style.left)-t.BLOCK_SIZE+"px"}}catch(t){c=!0,h=t}finally{try{!s&&v.return&&v.return()}finally{if(c)throw h}}t.curLeft--}else console.log("can`t move left");break;case 38:var y=t.clockwise(t.arr),p=y.newArr,d=y.lefts,_=y.tops;if(i=t.canMove(p,!0),a=i.canMoveDown,o=i.canMoveRight,n=i.canMoveLeft,o&&a&&n){t.arr=p;for(var S in d)r[S].style.left=d[S]+"px",r[S].style.top=_[S]+"px"}break;case 39:if(o=t.canMove(t.arr).canMoveRight){var m=!0,I=!1,w=void 0;try{for(var g,C=r[Symbol.iterator]();!(m=(g=C.next()).done);m=!0){var L=g.value;L.style.left=parseInt(L.style.left)+t.BLOCK_SIZE+"px"}}catch(t){I=!0,w=t}finally{try{!m&&C.return&&C.return()}finally{if(I)throw w}}t.curLeft++}else console.log("can`t move right");break;case 32:if(a=t.canMove(t.arr,!1,2).canMoveDown){var M=!0,E=!1,O=void 0;try{for(var B,K=r[Symbol.iterator]();!(M=(B=K.next()).done);M=!0){var Z=B.value;Z.style.top=parseInt(Z.style.top)+2*t.BLOCK_SIZE+"px"}}catch(t){E=!0,O=t}finally{try{!M&&K.return&&K.return()}finally{if(E)throw O}}t.curTop+=2}else console.log("can`t move down");break;default:console.log("请选择上下左右按键")}}}},{key:"init",value:function(){this.checkArrWith1(this.arr,this.draw);var e=document.querySelectorAll(".activityModel"),r=setTimeout(function i(){var o=this.canMove(this.arr).canMoveDown;if(o){var n=!0,a=!1,l=void 0;try{for(var s,c=e[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var h=s.value;h.style.top=parseInt(h.style.top)+this.BLOCK_SIZE+"px"}}catch(t){a=!0,l=t}finally{try{!n&&c.return&&c.return()}finally{if(a)throw l}}this.curTop++,setTimeout(i.bind(this),600)}else{for(var u=0;u<=e.length-1;u++)e[u].className="inactiveModel";for(var v=this.eliminate(),f=0;f<v.length;f++){var y=v[f],p=y.count,d=y.models,_=y.top;if(p===parseInt(this.siteSize.width/this.BLOCK_SIZE)){for(var S=0;S<d.length;S++)document.body.removeChild(d[S]);var m=document.querySelectorAll(".inactiveModel"),I=!0,w=!1,g=void 0;try{for(var C,L=m[Symbol.iterator]();!(I=(C=L.next()).done);I=!0){var M=C.value;parseInt(M.style.top)<_&&(M.style.top=parseInt(M.style.top)+this.BLOCK_SIZE+"px")}}catch(t){w=!0,g=t}finally{try{!I&&L.return&&L.return()}finally{if(w)throw g}}}}if(this.gameOver()){console.log("game over");var E=this.siteSize.height+this.siteSize.top-this.BLOCK_SIZE,O=this.siteSize.width+this.siteSize.left-this.BLOCK_SIZE,B=setInterval(function(){var e=this;if(t.fill(E,O),O-=this.BLOCK_SIZE,O<this.siteSize.left&&(O=this.siteSize.width+this.siteSize.left-this.BLOCK_SIZE,E-=this.BLOCK_SIZE),E<this.siteSize.top){clearInterval(B);var r=document.querySelector(".start-restart");r.style.display="block",r.onclick=function(t){t.preventDefault(),r.style.display="none";var i=[].concat(_toConsumableArray(document.querySelectorAll(".inactiveModel")));if(i.length>0){var o=!0,n=!1,a=void 0;try{for(var l,s=i[Symbol.iterator]();!(o=(l=s.next()).done);o=!0){var c=l.value;document.body.removeChild(c)}}catch(t){n=!0,a=t}finally{try{!o&&s.return&&s.return()}finally{if(n)throw a}}}e.init()}}}.bind(this),30)}else _init();clearTimeout(r)}}.bind(this),600)}}],[{key:"fill",value:function(t,e){var r=document.createElement("div");r.className="inactiveModel",r.style.left=e+"px",r.style.top=t+"px",document.body.appendChild(r)}}]),t}(),_init=function(){var t={arr:__arr__,siteSize:__siteSize__,BLOCK_SIZE:__BLOCK_SIZE__,curLeft:__curLeft__,curTop:__curTop__},e=new Block(t);e.init(),e.move()};window.onload=function(){console.log("window onload");var t=document.querySelector(".site"),e=window.getComputedStyle(t),r=e.width,i=e.height,o=e.left,n=e.top,a={width:parseInt(r),height:parseInt(i),left:parseInt(o),top:parseInt(n)},l=[[1,0],[1,0],[1,1]],s=20,c=parseInt((a.left+a.width/2)/s),h=parseInt(a.top/s);window.__arr__=l,window.__siteSize__=a,window.__BLOCK_SIZE__=s,window.__curLeft__=c,window.__curTop__=h,_init()};