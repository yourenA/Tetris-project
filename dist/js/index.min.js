"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),Block=function(){function e(t){_classCallCheck(this,e),this.siteSize=t.siteSize,this.arr=t.arr,this.nextArr=t.nextArr,this.highestScore=t.highestScore,this.delay=t.delay,this.BLOCK_SIZE=t.BLOCK_SIZE,this.curLeft=t.curLeft,this.curTop=t.curTop}return _createClass(e,[{key:"clockwise",value:function(e){for(var t=[],r=0;r<=e[0].length-1;r++){for(var i=[],o=e.length-1;o>=0;o--)i.push(e[o][r]);t.push(i)}var n=[],l=[];return this.checkArrWith1(t,function(e,t){n.push(t*this.BLOCK_SIZE),l.push(e*this.BLOCK_SIZE)}),{newArr:t,lefts:n,tops:l}}},{key:"checkArrWith1",value:function(e,t,r,i){for(var o=0;o<=e.length-1;o++)for(var n=0;n<=e[0].length-1;n++)1==e[o][n]&&t.call(this,o+this.curTop,n+this.curLeft,r,i)}},{key:"draw",value:function(e,t,r,i){var o="nextModel"===i?t*this.BLOCK_SIZE-(this.siteSize.left+this.siteSize.width/2-this.BLOCK_SIZE):t*this.BLOCK_SIZE,n="nextModel"===i?e*this.BLOCK_SIZE-this.siteSize.top:e*this.BLOCK_SIZE,l=document.createElement("div");l.className=i,l.style.top=n+"px",l.style.left=o+"px",r.appendChild(l)}},{key:"getInterval",value:function(e,t){var r=document.querySelectorAll(".inactiveModel"),i=null,o=null,n=null;if(0===r.length)i=this.siteSize.top+this.siteSize.height,o=this.siteSize.left-this.BLOCK_SIZE,n=this.siteSize.left+this.siteSize.width;else{var l=[],a=[],s=[],c=!0,h=!1,_=void 0;try{for(var u,v=r[Symbol.iterator]();!(c=(u=v.next()).done);c=!0){var d=u.value,f=parseInt(d.style.left),y=parseInt(d.style.top);f===e&&l.push(y),y===t&&(f<e?a.push(f):f>e&&s.push(f))}}catch(e){h=!0,_=e}finally{try{!c&&v.return&&v.return()}finally{if(h)throw _}}i=0===l.length?this.siteSize.top+this.siteSize.height:Math.min.apply(Math,l),o=0===a.length?this.siteSize.left-this.BLOCK_SIZE:Math.max.apply(Math,a),n=0===s.length?this.siteSize.left+this.siteSize.width:Math.min.apply(Math,s)}return{highest:i,leftmost:o,rightmost:n}}},{key:"eliminate",value:function(){var e=[],t=[].concat(_toConsumableArray(document.querySelectorAll(".inactiveModel")));t.sort(function(e,t){return parseInt(e.style.top)-parseInt(t.style.top)});for(var r=0;r<t.length;){for(var i=0,o=[],n=0;n<t.length;n++)t[r].style.top===t[n].style.top&&(i++,o.push(t[n]));e.push({models:o,count:i,top:parseInt(t[r].style.top)}),r+=i}return e}},{key:"gameOver",value:function(){var e=document.querySelectorAll(".inactiveModel"),t=[],r=!0,i=!1,o=void 0;try{for(var n,l=e[Symbol.iterator]();!(r=(n=l.next()).done);r=!0){var a=n.value;t.push(parseInt(a.style.top))}}catch(e){i=!0,o=e}finally{try{!r&&l.return&&l.return()}finally{if(i)throw o}}return Math.min.apply(Math,t)<=this.siteSize.top}},{key:"canMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{canMoveRight:!0,canMoveDown:!0,canMoveLeft:!0};return this.checkArrWith1(e,function(e,o){var n=this.getInterval(o*this.BLOCK_SIZE,e*this.BLOCK_SIZE),l=n.highest,a=n.leftmost,s=n.rightmost;t?(this.BLOCK_SIZE*(o+1)>s&&(i.canMoveRight=!1),this.BLOCK_SIZE*(e+r)>l&&(i.canMoveDown=!1),this.BLOCK_SIZE*(o-1)<a&&(i.canMoveLeft=!1)):(this.BLOCK_SIZE*(o+1)>=s&&(i.canMoveRight=!1),this.BLOCK_SIZE*(e+r)>=l&&(i.canMoveDown=!1),this.BLOCK_SIZE*(o-1)<=a&&(i.canMoveLeft=!1))}),i}},{key:"move",value:function(){var e=this;document.onkeydown=function(t){var r=document.querySelectorAll(".activityModel"),i=void 0,o=void 0,n=void 0,l=void 0,a=t.keyCode;if(r.length)switch(a){case 37:if(n=e.canMove(e.arr).canMoveLeft){var s=!0,c=!1,h=void 0;try{for(var _,u=r[Symbol.iterator]();!(s=(_=u.next()).done);s=!0){var v=_.value;v.style.left=parseInt(v.style.left)-e.BLOCK_SIZE+"px"}}catch(e){c=!0,h=e}finally{try{!s&&u.return&&u.return()}finally{if(c)throw h}}e.curLeft--}else console.log("can`t move left");break;case 38:var d=e.clockwise(e.arr),f=d.newArr,y=d.lefts,p=d.tops;if(i=e.canMove(f,!0),l=i.canMoveDown,o=i.canMoveRight,n=i.canMoveLeft,o&&l&&n){e.arr=f;for(var S in y)r[S].style.left=y[S]+"px",r[S].style.top=p[S]+"px"}break;case 39:if(o=e.canMove(e.arr).canMoveRight){var w=!0,m=!1,g=void 0;try{for(var I,C=r[Symbol.iterator]();!(w=(I=C.next()).done);w=!0){var M=I.value;M.style.left=parseInt(M.style.left)+e.BLOCK_SIZE+"px"}}catch(e){m=!0,g=e}finally{try{!w&&C.return&&C.return()}finally{if(m)throw g}}e.curLeft++}else console.log("can`t move right");break;case 32:if(l=e.canMove(e.arr,!1,2).canMoveDown){var L=!0,x=!1,E=void 0;try{for(var O,B=r[Symbol.iterator]();!(L=(O=B.next()).done);L=!0){var K=O.value;K.style.top=parseInt(K.style.top)+2*e.BLOCK_SIZE+"px"}}catch(e){x=!0,E=e}finally{try{!L&&B.return&&B.return()}finally{if(x)throw E}}e.curTop+=2}else console.log("can`t move down");break;default:console.log("请选择上下左右按键")}}}},{key:"init",value:function(){var t=document.querySelector("#next");t.innerHTML=null,this.checkArrWith1(this.arr,this.draw,document.body,"activityModel"),this.checkArrWith1(this.nextArr,this.draw,t,"nextModel");var r=document.querySelectorAll(".activityModel"),i=setTimeout(function t(){var o=this.canMove(this.arr).canMoveDown;if(o){var n=!0,l=!1,a=void 0;try{for(var s,c=r[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var h=s.value;h.style.top=parseInt(h.style.top)+this.BLOCK_SIZE+"px"}}catch(e){l=!0,a=e}finally{try{!n&&c.return&&c.return()}finally{if(l)throw a}}this.curTop++,setTimeout(t.bind(this),this.delay/window.__level__)}else{for(var _=0;_<=r.length-1;_++)r[_].className="inactiveModel";for(var u=this.eliminate(),v=0;v<u.length;v++){var d=u[v],f=d.count,y=d.models,p=d.top;if(f===parseInt(this.siteSize.width/this.BLOCK_SIZE)){for(var S=0;S<y.length;S++)document.body.removeChild(y[S]);var w=document.querySelectorAll(".inactiveModel"),m=!0,g=!1,I=void 0;try{for(var C,M=w[Symbol.iterator]();!(m=(C=M.next()).done);m=!0){var L=C.value;parseInt(L.style.top)<p&&(L.style.top=parseInt(L.style.top)+this.BLOCK_SIZE+"px")}}catch(e){g=!0,I=e}finally{try{!m&&M.return&&M.return()}finally{if(g)throw I}}window.__score__+=100*window.__level__;var x=document.querySelector("#score");if(x.innerText=window.__score__,window.__score__-(window.__level__-1)*(window.__level__-1)*1e3>=window.__level__*window.__level__*1e3&&window.__level__<=4){window.__level__++;var E=document.querySelector("#level");E.innerText=window.__level__}}}if(this.gameOver()){console.log("game over");var O=this.siteSize.height+this.siteSize.top-this.BLOCK_SIZE,B=this.siteSize.width+this.siteSize.left-this.BLOCK_SIZE,K=setInterval(function(){var t=this;if(e.fill(O,B),B-=this.BLOCK_SIZE,B<this.siteSize.left&&(B=this.siteSize.width+this.siteSize.left-this.BLOCK_SIZE,O-=this.BLOCK_SIZE),O<this.siteSize.top){clearInterval(K);var r=document.querySelector("#next");r.innerHTML=null;var i=document.querySelector(".start-restart");i.style.display="block",i.onclick=function(e){e.preventDefault(),i.style.display="none";var r=[].concat(_toConsumableArray(document.querySelectorAll(".inactiveModel")));if(r.length>0){var o=!0,n=!1,l=void 0;try{for(var a,s=r[Symbol.iterator]();!(o=(a=s.next()).done);o=!0){var c=a.value;document.body.removeChild(c)}}catch(e){n=!0,l=e}finally{try{!o&&s.return&&s.return()}finally{if(n)throw l}}}if(t.highestScore<window.__score__){localStorage.setItem("highestScore",window.__score__);var h=document.querySelector("#highest-score");h.innerText=window.__score__}window.__score__=0;var _=document.querySelector("#score");_.innerText=window.__score__,window.__level__=1;var u=document.querySelector("#level");u.innerText=window.__level__,t.init()}}}.bind(this),30)}else _init(this.nextArr);clearTimeout(i)}}.bind(this),600)}}],[{key:"fill",value:function(e,t){var r=document.createElement("div");r.className="inactiveModel",r.style.left=t+"px",r.style.top=e+"px",document.body.appendChild(r)}}]),e}(),_init=function(e){var t=Math.floor(Math.random()*__arr__.length),r=Math.floor(Math.random()*__arr__.length),i=e?e:__arr__[t],o=600,n={arr:i,nextArr:__arr__[r],siteSize:__siteSize__,BLOCK_SIZE:__BLOCK_SIZE__,curLeft:__curLeft__,curTop:__curTop__,delay:o,highestScore:__highestScore__},l=new Block(n);l.init(),l.move()};window.onload=function(){console.log("window onload");var e=document.querySelector(".site"),t=window.getComputedStyle(e),r=t.width,i=t.height,o=t.left,n=t.top,l={width:parseInt(r),height:parseInt(i),left:parseInt(o),top:parseInt(n)},a=[[[1,0],[1,0],[1,1]],[[1,1,1],[1,0,0]],[[1,1],[0,1],[0,1]],[[0,0,1],[1,1,1]],[[0,1],[0,1],[1,1]],[[1,0,0],[1,1,1]],[[1,1],[1,0],[1,0]],[[1,1,1],[0,0,1]],[[1],[1],[1],[1]],[[1,1,1,1]],[[1],[1],[1],[1]],[[1,1,1,1]],[[1,1],[1,1]],[[1,1],[1,1]],[[1,1],[1,1]],[[1,1],[1,1]],[[1,1,1],[0,1,0]],[[0,1],[1,1],[0,1]],[[0,1,0],[1,1,1]],[[1,0],[1,1],[1,0]],[[1,1,0],[0,1,1]],[[0,1],[1,1],[1,0]],[[1,1,0],[0,1,1]],[[0,1],[1,1],[1,0]],[[0,1,1],[1,1,0]],[[1,0],[1,1],[0,1]],[[0,1,1],[1,1,0]],[[1,0],[1,1],[0,1]]],s=20,c=parseInt((l.left+l.width/2)/s),h=parseInt(l.top/s);window.__arr__=a,window.__siteSize__=l,window.__BLOCK_SIZE__=s,window.__curLeft__=c,window.__curTop__=h,window.__level__=1,window.__score__=0;var _=localStorage.getItem("highestScore")||0,u=document.querySelector("#highest-score");u.innerText=_,window.__highestScore__=_;var v=document.querySelector(".start-restart");v.onclick=function(e){e.preventDefault(),v.innerText="restart",v.style.display="none",_init()}};