"use strict";function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,r,i){return r&&t(e.prototype,r),i&&t(e,i),e}}(),Block=function(){function t(e){_classCallCheck(this,t),this.siteSize=e.siteSize,this.arr=e.arr,this.BLOCK_SIZE=e.BLOCK_SIZE,this.curLeft=e.curLeft,this.curTop=e.curTop}return _createClass(t,[{key:"clockwise",value:function(t){for(var e=[],r=0;r<=t.length-1;r++){for(var i=[],o=t.length-1;o>=0;o--)i.push(t[o][r]);e.push(i)}var n=[],a=[];return this.checkArrWith1(e,function(t,e){n.push(e*this.BLOCK_SIZE),a.push(t*this.BLOCK_SIZE)}),{newArr:e,lefts:n,tops:a}}},{key:"checkArrWith1",value:function(t,e){for(var r=0;r<=t.length-1;r++)for(var i=0;i<=t.length-1;i++)1==t[r][i]&&e.call(this,r+this.curTop,i+this.curLeft)}},{key:"draw",value:function(t,e){var r=document.createElement("div");r.className="activityModel",r.style.top=t*this.BLOCK_SIZE+"px",r.style.left=e*this.BLOCK_SIZE+"px",document.body.appendChild(r)}},{key:"getInterval",value:function(t,e){var r=document.querySelectorAll(".inactiveModel"),i=null,o=null,n=null;if(0===r.length)i=this.siteSize.top+this.siteSize.height,o=this.siteSize.left-this.BLOCK_SIZE,n=this.siteSize.left+this.siteSize.width;else{var a=[],l=[],s=[],c=!0,h=!1,u=void 0;try{for(var v,f=r[Symbol.iterator]();!(c=(v=f.next()).done);c=!0){var y=v.value,p=parseInt(y.style.left),_=parseInt(y.style.top);p===t&&a.push(_),_===e&&(p<t?l.push(p):p>t&&s.push(p))}}catch(t){h=!0,u=t}finally{try{!c&&f.return&&f.return()}finally{if(h)throw u}}i=0===a.length?this.siteSize.top+this.siteSize.height:Math.min.apply(Math,a),o=0===l.length?this.siteSize.left-this.BLOCK_SIZE:Math.max.apply(Math,l),n=0===s.length?this.siteSize.left+this.siteSize.width:Math.min.apply(Math,s)}return{highest:i,leftmost:o,rightmost:n}}},{key:"eliminate",value:function(){var t=[],e=[].concat(_toConsumableArray(document.querySelectorAll(".inactiveModel")));e.sort(function(t,e){return parseInt(t.style.top)-parseInt(e.style.top)});for(var r=0;r<e.length;){for(var i=0,o=[],n=0;n<e.length;n++)e[r].style.top===e[n].style.top&&(i++,o.push(e[n]));t.push({models:o,count:i,top:parseInt(e[r].style.top)}),r+=i}return t}},{key:"canMove",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{canMoveRight:!0,canMoveDown:!0,canMoveLeft:!0};return this.checkArrWith1(t,function(t,i){var o=this.getInterval(i*this.BLOCK_SIZE,t*this.BLOCK_SIZE),n=o.highest,a=o.leftmost,l=o.rightmost;e?(this.BLOCK_SIZE*(i+1)>l&&(r.canMoveRight=!1),this.BLOCK_SIZE*(t+1)>n&&(r.canMoveDown=!1),this.BLOCK_SIZE*(i-1)<a&&(r.canMoveLeft=!1)):(this.BLOCK_SIZE*(i+1)>=l&&(r.canMoveRight=!1),this.BLOCK_SIZE*(t+1)>=n&&(r.canMoveDown=!1),this.BLOCK_SIZE*(i-1)<=a&&(r.canMoveLeft=!1))}),r}},{key:"move",value:function(){var t=this;document.onkeydown=function(e){var r=document.querySelectorAll(".activityModel"),i=void 0,o=void 0,n=void 0,a=void 0,l=e.keyCode;switch(l){case 37:if(n=t.canMove(t.arr).canMoveLeft){var s=!0,c=!1,h=void 0;try{for(var u,v=r[Symbol.iterator]();!(s=(u=v.next()).done);s=!0){var f=u.value;f.style.left=parseInt(f.style.left)-20+"px"}}catch(t){c=!0,h=t}finally{try{!s&&v.return&&v.return()}finally{if(c)throw h}}t.curLeft--}else console.log("can`t move left");break;case 38:var y=t.clockwise(t.arr),p=y.newArr,_=y.lefts,d=y.tops;if(i=t.canMove(p,!0),a=i.canMoveDown,o=i.canMoveRight,n=i.canMoveLeft,o&&a&&n){t.arr=p;for(var S in _)r[S].style.left=_[S]+"px",r[S].style.top=d[S]+"px"}break;case 39:if(o=t.canMove(t.arr).canMoveRight){var w=!0,m=!1,I=void 0;try{for(var g,C=r[Symbol.iterator]();!(w=(g=C.next()).done);w=!0){var L=g.value;L.style.left=parseInt(L.style.left)+20+"px"}}catch(t){m=!0,I=t}finally{try{!w&&C.return&&C.return()}finally{if(m)throw I}}t.curLeft++}else console.log("can`t move right");break;case 40:if(a=t.canMove(t.arr).canMoveDown){var M=!0,k=!1,B=void 0;try{for(var E,O=r[Symbol.iterator]();!(M=(E=O.next()).done);M=!0){var K=E.value;K.style.top=parseInt(K.style.top)+20+"px"}}catch(t){k=!0,B=t}finally{try{!M&&O.return&&O.return()}finally{if(k)throw B}}t.curTop++}else console.log("can`t move down");break;default:console.log("请选择上下左右按键")}}}},{key:"init",value:function(){this.checkArrWith1(this.arr,this.draw);var t=document.querySelectorAll(".activityModel"),e=setTimeout(function r(){var i=this.canMove(this.arr).canMoveDown;if(i){var o=!0,n=!1,a=void 0;try{for(var l,s=t[Symbol.iterator]();!(o=(l=s.next()).done);o=!0){var c=l.value;c.style.top=parseInt(c.style.top)+this.BLOCK_SIZE+"px"}}catch(t){n=!0,a=t}finally{try{!o&&s.return&&s.return()}finally{if(n)throw a}}this.curTop++,setTimeout(r.bind(this),600)}else{for(var h=0;h<=t.length-1;h++)t[h].className="inactiveModel";for(var u=this.eliminate(),v=0;v<u.length;v++){var f=u[v],y=f.count,p=f.models,_=f.top;if(y===parseInt(this.siteSize.width/this.BLOCK_SIZE)){for(var d=0;d<p.length;d++)document.body.removeChild(p[d]);var S=document.querySelectorAll(".inactiveModel"),w=!0,m=!1,I=void 0;try{for(var g,C=S[Symbol.iterator]();!(w=(g=C.next()).done);w=!0){var L=g.value;parseInt(L.style.top)<_&&(L.style.top=parseInt(L.style.top)+this.BLOCK_SIZE+"px")}}catch(t){m=!0,I=t}finally{try{!w&&C.return&&C.return()}finally{if(m)throw I}}}}_init(),clearTimeout(e)}}.bind(this),600)}}]),t}(),_init=function(){var t={arr:__arr__,siteSize:__siteSize__,BLOCK_SIZE:__BLOCK_SIZE__,curLeft:__curLeft__,curTop:__curTop__},e=new Block(t);e.init(),e.move()};window.onload=function(){console.log("window onload");var t=document.querySelector(".site"),e=window.getComputedStyle(t),r=e.width,i=e.height,o=e.left,n=e.top,a={width:parseInt(r),height:parseInt(i),left:parseInt(o),top:parseInt(n)},l=[[1,0],[1,0],[1,1]],s=20,c=parseInt((a.left+a.width/2)/s),h=parseInt(a.top/s);window.__arr__=l,window.__siteSize__=a,window.__BLOCK_SIZE__=s,window.__curLeft__=c,window.__curTop__=h,_init()};